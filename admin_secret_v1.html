<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin • Rio Preto</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="theme.js"></script>

    <!-- Supabase JS -->
    <script src="https://esm.sh/@supabase/supabase-js@2"></script>

    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        h1,
        h2,
        h3,
        button {
            font-family: 'Outfit', sans-serif;
        }

        /* Smooth Fade */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-start md:justify-center p-4">

    <div
        class="w-full max-w-5xl bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[85vh] md:min-h-[600px] border border-gray-100">

        <!-- SIDEBAR (Desktop) / TOPBAR (Mobile) -->
        <div class="bg-gray-50 p-6 md:w-64 flex flex-col border-b md:border-b-0 md:border-r border-gray-100 shrink-0">
            <!-- Header Logo -->
            <div class="flex items-center justify-between mb-6 md:mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Admin<span
                            class="text-green-600">Panel</span></h1>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Sistema v2.3</p>
                </div>
                <!-- Back Button Mobile Only (Optional) -->
                <a href="index.html"
                    class="md:hidden w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-green-600">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
            </div>

            <!-- API Key -->
            <div class="mb-6 hidden md:block">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Chave de
                    Acesso</label>
                <input type="password" id="apiKey"
                    class="w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs text-gray-600 focus:border-green-500 outline-none transition"
                    placeholder="Supabase Anon Key">
            </div>

            <!-- Mobile API Key Toggle -->
            <div class="md:hidden mb-4">
                <details class="text-xs text-gray-400">
                    <summary class="cursor-pointer hover:text-green-600 font-bold">Configurar Chave API</summary>
                    <input type="password" id="apiKeyMobile" oninput="syncKeys(this.value)"
                        class="mt-2 w-full bg-white border border-gray-200 rounded-xl px-3 py-3 text-gray-800 focus:border-green-500 outline-none transition"
                        placeholder="Cole a chave aqui...">
                </details>
            </div>

            <!-- Navigation Tabs -->
            <nav
                class="flex md:flex-col gap-2 md:gap-3 md:flex-1 overflow-x-auto md:overflow-visible pb-2 md:pb-0 no-scrollbar">
                <button onclick="setMode('ai')" id="btnAi"
                    class="flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all whitespace-nowrap bg-green-50 text-green-700 shadow-sm border border-green-100">
                    <i class="fa-solid fa-robot"></i> <span class="hidden sm:inline">IA Terminal</span><span
                        class="sm:hidden">IA</span>
                </button>
                <button onclick="setMode('manual')" id="btnManual"
                    class="flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all border border-transparent whitespace-nowrap">
                    <i class="fa-regular fa-pen-to-square"></i> <span class="hidden sm:inline">Manual</span><span
                        class="sm:hidden">Form</span>
                </button>
            </nav>

            <!-- Footer Desktop -->
            <div class="hidden md:block mt-auto pt-6 border-t border-gray-200">
                <a href="index.html"
                    class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-gray-600 transition">
                    <i class="fa-solid fa-arrow-left"></i> Voltar ao Site
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 relative bg-white overflow-hidden flex flex-col">

            <!-- AI MODE -->
            <div id="aiMode" class="flex flex-col h-full animate-fade-in overflow-y-auto custom-scrollbar p-4 md:p-8">

                <!-- AI Header -->
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Comando de Texto</h2>
                    <p class="text-xs text-gray-400 mt-1">Digite os detalhes da reserva naturalmente.</p>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 space-y-6">

                
                    <!-- Input & Action -->
                    <div class="space-y-4">
                        <textarea id="inputText" rows="5"
                            class="w-full bg-gray-50 border border-gray-200 rounded-2xl p-4 text-gray-800 font-medium focus:border-green-500 focus:bg-white focus:ring-4 focus:ring-green-50 outline-none transition text-base resize-none"
                            placeholder="Ex: Reserva João Chalé 5, entrada dia 25/12/2025, saida dia 26/12/2025, 2 adultos, 1 criança, pago R$ 250, contato: 69999999999, obs: churrasqueira inclusa 45 reais adicionais..."></textarea>

                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- File Upload Button -->
                            <label class="flex-1 cursor-pointer group">
                                <div
                                    class="flex items-center gap-3 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl group-hover:bg-gray-100 hover:border-green-300 transition">
                                    <div
                                        class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-paperclip"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <p class="text-xs font-bold text-gray-500 uppercase group-hover:text-gray-700">
                                            Comprovante</p>
                                        <p id="fileNameAi" class="text-[10px] text-gray-400 truncate">Nenhum arquivo</p>
                                    </div>
                                </div>
                                <input type="file" id="proofFileAi" class="hidden"
                                    onchange="updateFileName('proofFileAi', 'fileNameAi')">
                            </label>

                            <!-- Process Button -->
                            <button onclick="processCommand()"
                                class="flex-1 bg-green-500 text-white font-bold py-4 md:py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-paper-plane text-yellow-00 text-lg"></i>
                                <span class="uppercase tracking-wide text-sm">Enviar Pré-reserva</span>
                            </button>
                        </div>
                    </div>

                    <!-- Console Log -->
                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Log do Sistema</p>
                        <div id="consoleOutput"
                            class="bg-gray-900 rounded-xl p-4 h-48 overflow-y-auto custom-scrollbar font-mono text-xs text-gray-300 shadow-inner">
                            <div class="text-gray-600">O sistema está pronto...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- MANUAL MODE -->
            <div id="manualMode"
                class="hidden flex-col h-full animate-fade-in overflow-y-auto custom-scrollbar p-4 md:p-8">

                <div class="mb-6 flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-green-100 text-green-600 flex items-center justify-center text-lg">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Nova Reserva Manual</h2>
                </div>

                <div class="space-y-4 max-w-2xl">
                    <!-- Essential -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="col-span-1">
                            <label class="label-tiny">Chalé</label>
                            <input type="number" id="mChalet" class="input-base" placeholder="#">
                        </div>
                        <div class="col-span-3">
                            <label class="label-tiny">Nome Completo</label>
                            <input type="text" id="mName" class="input-base" placeholder="Nome do Hóspede">
                        </div>
                    </div>

                    <!-- Contact & Source -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Contato / Celular</label>
                            <input type="text" id="mContact" class="input-base" placeholder="(XX) 9XXXX-XXXX">
                        </div>
                        <div>
                            <label class="label-tiny">Origem</label>
                            <select id="mSource" class="input-base h-[46px]">
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Airbnb">Airbnb</option>
                                <option value="Booking">Booking.com</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Indicação">Indicação</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Check-in</label>
                            <input type="date" id="mCheckin" class="input-base">
                        </div>
                        <div>
                            <label class="label-tiny">Check-out</label>
                            <input type="date" id="mCheckout" class="input-base">
                        </div>
                    </div>

                    <!-- Pax & Time -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Adultos/Crianças</label>
                            <input type="text" id="mAdults" class="input-base" value="2 Adultos">
                        </div>
                        <div>
                            <label class="label-tiny">Chegada Prevista</label>
                            <input type="time" id="mTime" class="input-base" value="14:00">
                        </div>
                    </div>

                    <!-- Custom Styles for Inputs -->
                    <style>
                        .label-tiny {
                            font-size: 0.65rem;
                            font-weight: 800;
                            text-transform: uppercase;
                            color: #9ca3af;
                            margin-left: 4px;
                            margin-bottom: 2px;
                            display: block;
                        }

                        .input-base {
                            width: 100%;
                            padding: 12px;
                            border-radius: 12px;
                            background-color: #f9fafb;
                            border: 1px solid #e5e7eb;
                            font-weight: 600;
                            color: #1f2937;
                            outline: none;
                            transition: all 0.2s;
                            font-size: 0.9rem;
                        }

                        .input-base:focus {
                            background-color: #ffffff;
                            border-color: #22c55e;
                            box-shadow: 0 0 0 3px #dcfce7;
                        }
                    </style>

                    <!-- Money -->
                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div>
                            <label class="label-tiny">Total (R$)</label>
                            <input type="number" id="mPrice" class="input-base bg-white" placeholder="0.00">
                        </div>
                        <div>
                            <label class="label-tiny text-green-600">Pago (R$)</label>
                            <input type="number" id="mPaid"
                                class="input-base bg-green-50 text-green-700 border-green-200" placeholder="0.00">
                        </div>
                    </div>

                    <!-- Extra -->
                    <div>
                        <label class="label-tiny">Placa Veículo</label>
                        <input type="text" id="mPlate" class="input-base" placeholder="ABC-1234">
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="label-tiny">Observações</label>
                        <textarea id="mNotes" rows="2" class="input-base resize-none"
                            placeholder="Berço, Pet, Restrições..."></textarea>
                    </div>

                    <!-- File -->
                    <label
                        class="flex items-center gap-4 p-4 border border-dashed border-gray-300 rounded-xl hover:bg-gray-50 cursor-pointer transition">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                            <i class="fa-solid fa-upload"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-600">Anexar Comprovante</p>
                            <p id="fileNameManual" class="text-xs text-gray-400">Nenhum arquivo</p>
                        </div>
                        <input type="file" id="mProof" class="hidden"
                            onchange="updateFileName('mProof', 'fileNameManual')">
                    </label>

                    <div class="h-4"></div> <!-- Spacer -->

                    <button onclick="saveManual()"
                        class="w-full py-4 rounded-xl bg-green-600 text-white font-bold text-lg shadow-lg shadow-green-200 hover:scale-[1.02] active:scale-95 transition-all">
                        CONFIRMAR RESERVA
                    </button>
                    <div class="h-8"></div> <!-- Bottom Spacer -->
                </div>

            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>

    <script>
        // --- CONSTANTS ---
        const CONFIG = {
            KEY_HARDCODED: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpaGFpcGFzbG5wYXFucW90cndtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjE1OTIsImV4cCI6MjA3OTgzNzU5Mn0.zwPHKlcYNQnlQbQdf83qbH3mk4Dsc8fVF4NfWDBs_LA",
            URL: "https://hihaipaslnpaqnqotrwm.supabase.co",
            FUNC: "https://hihaipaslnpaqnqotrwm.supabase.co/functions/v1/smooth-handler"
        };

        // Init
        document.getElementById('apiKey').value = CONFIG.KEY_HARDCODED;
        if (document.getElementById('apiKeyMobile')) document.getElementById('apiKeyMobile').value = CONFIG.KEY_HARDCODED;

        function syncKeys(val) {
            document.getElementById('apiKey').value = val;
            CONFIG.KEY_HARDCODED = val;
        }

        // --- TABS LOGIC ---
        function setMode(mode) {
            const ai = document.getElementById('aiMode');
            const manual = document.getElementById('manualMode');
            const btnAi = document.getElementById('btnAi');
            const btnManual = document.getElementById('btnManual');

            // Reset Styles
            const styleActive = "bg-green-50 text-green-700 shadow-sm border-green-100";
            const styleInactive = "text-gray-500 hover:bg-gray-100 border-transparent bg-transparent";

            // Clean
            btnAi.className = btnAi.className.replace(styleActive, "").replace(styleInactive, "");
            btnManual.className = btnManual.className.replace(styleActive, "").replace(styleInactive, "");

            // Base Class
            const base = "flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all whitespace-nowrap border ";

            if (mode === 'ai') {
                ai.classList.remove('hidden');
                manual.classList.add('hidden');
                manual.classList.remove('flex');

                btnAi.className = base + styleActive;
                btnManual.className = base + styleInactive;
            } else {
                ai.classList.add('hidden');
                manual.classList.remove('hidden');
                manual.classList.add('flex'); // Manual uses flex col

                btnAi.className = base + styleInactive;
                btnManual.className = base + styleActive;
            }
        }

        // --- UTILS ---
        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.classList.add('text-green-600', 'font-bold');
            } else {
                label.innerText = "Nenhum arquivo";
                label.classList.remove('text-green-600', 'font-bold');
            }
        }

        function log(msg, type = 'info') {
            const box = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = `mb-1.5 font-mono text-xs border-l-2 pl-2 ${type === 'error' ? 'text-red-400 border-red-500' :
                    type === 'success' ? 'text-green-400 border-green-500 font-bold' :
                        'text-gray-400 border-gray-700'
                }`;
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}]</span> ${msg}`;
            box.prepend(div);
        }

        async function getSupabase() {
            const key = document.getElementById('apiKey').value || CONFIG.KEY_HARDCODED;
            return window.createClient(CONFIG.URL, key);
        }

        async function uploadFile(fileInput, prefix) {
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) return null;
            const file = fileInput.files[0];
            const sb = await getSupabase();

            const ext = file.name.split('.').pop();
            const path = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;

            try {
                const { error } = await sb.storage.from('receipts').upload(path, file);
                if (error) throw error;
                const { data } = sb.storage.from('receipts').getPublicUrl(path);
                return data.publicUrl;
            } catch (e) {
                console.error("Upload Fail", e);
                log("Falha upload imagem: " + e.message, 'error');
                return null;
            }
        }

        // --- ACTIONS ---
        async function processCommand() {
            const text = document.getElementById('inputText').value;
            const fileIn = document.getElementById('proofFileAi');

            if (!text.trim()) { log("Digite um comando primeiro.", 'error'); return; }

            log("Enviando para IA...", 'warn');

            const url = await uploadFile(fileIn, 'ai_cmd');
            const key = document.getElementById('apiKey').value;

            try {
                const resp = await fetch(CONFIG.FUNC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({ text, sender: 'Admin Mobile', image_url: url })
                });
                const data = await resp.json();

                if (data.success) {
                    log("Sucesso!", 'success');
                    log(data.message.replace(/\n/g, '<br>'));
                    document.getElementById('inputText').value = "";
                    fileIn.value = "";
                    updateFileName('proofFileAi', 'fileNameAi');
                } else {
                    log("Erro IA: " + data.message, 'error');
                }

            } catch (e) {
                log("Erro Rede: " + e.message, 'error');
            }
        }

        async function saveManual() {
            // Validation
            const req = ['mChalet', 'mName', 'mCheckin', 'mCheckout'];
            let fail = false;
            req.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value) { el.style.borderColor = "red"; fail = true; }
                else { el.style.borderColor = ""; }
            });

            if (fail) { alert("Preencha campos obrigatórios!"); return; }

            const btn = document.querySelector('#manualMode button');
            btn.innerText = "Salvando...";
            btn.disabled = true;

            try {
                const sb = await getSupabase();
                const url = await uploadFile(document.getElementById('mProof'), 'manual_mob');

                const payload = {
                    chalet_id: document.getElementById('mChalet').value,
                    guest_name: document.getElementById('mName').value,
                    contact_info: document.getElementById('mContact').value,
                    checkin_date: document.getElementById('mCheckin').value,
                    checkout_date: document.getElementById('mCheckout').value,
                    adults: parseInt(document.getElementById('mAdults').value) || 2,
                    arrival_time: document.getElementById('mTime').value,
                    total_price: parseFloat(document.getElementById('mPrice').value) || 0,
                    advance_payment: parseFloat(document.getElementById('mPaid').value) || 0,
                    payment_proof_url: url,
                    status: 'pending',
                    raw_message: JSON.stringify({
                        manual: true,
                        ai_parsed: {
                            notes: document.getElementById('mNotes').value,
                            source: document.getElementById('mSource').value,
                            plate: document.getElementById('mPlate').value
                        }
                    })
                };

                const { error } = await sb.from('bookings').insert(payload);
                if (error) throw error;

                alert("Reserva Criada!");
                // Reset
                document.getElementById('mName').value = "";
                document.getElementById('mNotes').value = "";
                document.getElementById('mPaid').value = "";
                // Switch back to IA log to show activity? 
                // No, stay here but maybe log it?
                log(`Nova Reserva Manual: ${payload.guest_name}`, 'success');

            } catch (e) {
                alert("Erro: " + e.message);
            } finally {
                btn.innerText = "CONFIRMAR RESERVA";
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>