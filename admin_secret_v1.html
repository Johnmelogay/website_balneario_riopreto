<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin • Rio Preto</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="theme.js"></script>
    <!-- Assuming theme.js sets brand colors if needed, but we'll use raw tailwind mainly -->

    <!-- Supabase JS -->
    <script src="https://esm.sh/@supabase/supabase-js@2"></script>

    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Gray-50 equivalent */
        }

        h1,
        h2,
        h3,
        button,
        .font-heading {
            font-family: 'Outfit', sans-serif;
        }

        /* Custom Scrollbar for the console/form */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div
        class="w-full max-w-4xl bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[600px] border border-gray-100">

        <!-- SIDEBAR / HEADER (Desktop: Left, Mobile: Top) -->
        <div class="bg-gray-50 p-6 md:w-64 flex flex-col border-r border-gray-100 shrink-0">
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Admin<span
                        class="text-green-600">Panel</span></h1>
                <p class="text-xs text-gray-400 font-medium mt-1">SISTEMA INTERNO v2.3</p>
            </div>

            <!-- API Key Input -->
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Chave de
                    Acesso</label>
                <input type="password" id="apiKey"
                    class="w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-xs text-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition"
                    placeholder="Supabase Anon Key">
            </div>

            <!-- Navigation -->
            <nav class="space-y-2 flex-1">
                <button onclick="setMode('ai')" id="btnAi"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all bg-green-50 text-green-700 shadow-sm border border-green-100">
                    <i class="fa-solid fa-robot"></i> Inteligência Artificial
                </button>
                <button onclick="setMode('manual')" id="btnManual"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all border border-transparent">
                    <i class="fa-regular fa-pen-to-square"></i> Cadastro Manual
                </button>
            </nav>

            <div class="mt-auto pt-6 border-t border-gray-200">
                <a href="index.html"
                    class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-gray-600 transition">
                    <i class="fa-solid fa-arrow-left"></i> Voltar ao Site
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col relative bg-white">

            <!-- AI MODE CONTENT -->
            <div id="aiMode" class="flex flex-col h-full absolute inset-0 p-6 md:p-8 animate-fade-in">

                <div class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Comando de Voz / Texto</h2>

                    <!-- THE RESTORED GUIDE -->
                    <div class="mb-6 bg-blue-50/50 border border-blue-100 rounded-2xl p-5">
                        <div class="flex items-center justify-between mb-4 border-b border-blue-100 pb-2">
                            <h3 class="text-xs font-black text-blue-600 uppercase tracking-widest"><i
                                    class="fa-solid fa-list-check mr-2"></i>Guia de Comando Perfeito</h3>
                            <span
                                class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">v2.1</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Column 1 -->
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Essenciais</p>
                                <ul class="space-y-2">
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                                        <span><strong>Reserva:</strong> Nome do Hóspede</span>
                                    </li>
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                                        <span><strong>Chalé:</strong> Número (ou "aleatorio")</span>
                                    </li>
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                                        <span><strong>Datas:</strong> "dia 01/01 a 03/01"</span>
                                    </li>
                                </ul>
                            </div>
                            <!-- Column 2 -->
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Detalhes & Financeiro</p>
                                <ul class="space-y-2">
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-solid fa-dollar-sign text-yellow-500 mt-0.5"></i>
                                        <span><strong>Pgto:</strong> "Pago 140" (Sinal)</span>
                                    </li>
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-solid fa-clock text-purple-500 mt-0.5"></i>
                                        <span><strong>Chegada:</strong> "Chegada 18h"</span>
                                    </li>
                                    <li class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fa-regular fa-comment text-pink-500 mt-0.5"></i>
                                        <span><strong>Obs:</strong> "Pet", "Berço", "Vegano"</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-t border-blue-100">
                            <p class="text-xs text-gray-500 italic bg-white/50 p-2 rounded-lg border border-blue-50">
                                <strong class="text-blue-600">Ex:</strong> "Reserva Vanessa Chalé 10, 20/12 a 22/12.
                                Casal + 1 criança. Chegada 15h. Pago 200. Obs: Trazer berço."
                            </p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="space-y-4">
                        <textarea id="inputText" rows="4"
                            class="w-full bg-gray-50 border border-gray-200 rounded-2xl p-4 text-gray-700 font-medium focus:border-green-500 focus:bg-white focus:ring-2 focus:ring-green-100 outline-none transition text-sm resize-none shadow-inner"
                            placeholder="Digite o comando aqui..."></textarea>

                        <div class="flex items-center gap-4">
                            <label class="flex-1 cursor-pointer group">
                                <div
                                    class="flex items-center gap-3 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl group-hover:bg-gray-100 transition">
                                    <div
                                        class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-paperclip"></i>
                                    </div>
                                    <div class="truncate">
                                        <p class="text-xs font-bold text-gray-500 uppercase group-hover:text-gray-700">
                                            Anexar Comprovante</p>
                                        <p id="fileNameAi" class="text-xs text-gray-400 truncate">Nenhum arquivo</p>
                                    </div>
                                </div>
                                <input type="file" id="proofFileAi" class="hidden"
                                    onchange="updateFileName('proofFileAi', 'fileNameAi')">
                            </label>

                            <button onclick="processCommand()"
                                class="flex-1 bg-gray-900 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles text-yellow-400"></i>
                                <span>Processar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Console Output -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Log do Sistema</p>
                    <div id="consoleOutput"
                        class="bg-gray-900 rounded-xl p-4 h-32 overflow-y-auto custom-scrollbar font-mono text-xs text-gray-300 shadow-inner">
                        <div class="text-gray-600">Aguardando comando...</div>
                    </div>
                </div>
            </div>

            <!-- MANUAL MODE CONTENT (Hidden default) -->
            <div id="manualMode"
                class="flex flex-col h-full absolute inset-0 p-6 md:p-8 hidden overflow-y-auto custom-scrollbar animate-fade-in bg-white">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span
                        class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center text-sm"><i
                            class="fa-regular fa-pen-to-square"></i></span>
                    Nova Reserva Manual
                </h2>

                <div class="space-y-5">
                    <!-- Row 1 -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-1 space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Chalé</label>
                            <input type="number" id="mChalet"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                placeholder="#">
                        </div>
                        <div class="col-span-3 space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nome Completo</label>
                            <input type="text" id="mName"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                placeholder="Ex: Ana Souza">
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Contato</label>
                            <input type="text" id="mContact"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                placeholder="(00) 0000...">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Origem</label>
                            <select id="mSource"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500 h-[50px]">
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Airbnb">Airbnb</option>
                                <option value="Booking">Booking</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Indicação">Indicação</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Placa</label>
                            <input type="text" id="mPlate"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                placeholder="ABC-1234">
                        </div>
                    </div>

                    <!-- Row 3 Dates -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Check-in</label>
                            <input type="date" id="mCheckin"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Check-out</label>
                            <input type="date" id="mCheckout"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500">
                        </div>
                    </div>

                    <!-- Row 4 Financials -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Total (R$)</label>
                            <input type="number" id="mPrice"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500 bg-white"
                                placeholder="0.00">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Pago (R$)</label>
                            <input type="number" id="mPaid"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500 bg-green-50/50 text-green-700"
                                placeholder="0.00">
                        </div>
                    </div>

                    <!-- Row 5 Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Adultos</label>
                            <input type="text" id="mAdults"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                value="2 Adultos">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">Chegada</label>
                            <input type="time" id="mTime"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500"
                                value="14:00">
                        </div>
                    </div>

                    <!-- Upload Manual -->
                    <label
                        class="block cursor-pointer group border-2 border-dashed border-gray-200 hover:border-green-400 rounded-xl p-4 transition text-center bg-gray-50/50">
                        <div class="flex flex-col items-center gap-2">
                            <div
                                class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                            </div>
                            <p class="text-sm font-bold text-gray-500 group-hover:text-green-600">Clique para anexar
                                comprovante</p>
                            <p id="fileNameManual" class="text-xs text-gray-400">Nenhum arquivo selecionado</p>
                        </div>
                        <input type="file" id="mProof" class="hidden"
                            onchange="updateFileName('mProof', 'fileNameManual')">
                    </label>

                    <!-- Obs -->
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Observações</label>
                        <textarea id="mNotes" rows="2"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-gray-800 focus:outline-none focus:border-green-500 text-sm"
                            placeholder="Detalhes adicionais..."></textarea>
                    </div>

                    <div class="pt-2">
                        <button onclick="saveManual()"
                            class="w-full py-4 rounded-xl bg-green-600 text-white font-bold text-lg shadow-lg shadow-green-200 hover:scale-[1.01] transition active:scale-100 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> CONFIRMAR RESERVA
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>

    <script>
        // --- CONFIG ---
        const HARDCODED_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpaGFpcGFzbG5wYXFucW90cndtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjE1OTIsImV4cCI6MjA3OTgzNzU5Mn0.zwPHKlcYNQnlQbQdf83qbH3mk4Dsc8fVF4NfWDBs_LA";
        const SUPABASE_URL = "https://hihaipaslnpaqnqotrwm.supabase.co";
        const FUNCTION_URL = "https://hihaipaslnpaqnqotrwm.supabase.co/functions/v1/smooth-handler";

        document.getElementById('apiKey').value = HARDCODED_KEY;

        // --- UI LOGIC ---
        function setMode(mode) {
            const aiDiv = document.getElementById('aiMode');
            const manualDiv = document.getElementById('manualMode');
            const btnAi = document.getElementById('btnAi');
            const btnManual = document.getElementById('btnManual');

            // Active Classes
            const activeClass = "bg-green-50 text-green-700 shadow-sm border border-green-100";
            const inactiveClass = "text-gray-500 hover:bg-gray-100 border border-transparent";

            if (mode === 'ai') {
                aiDiv.classList.remove('hidden');
                manualDiv.classList.add('hidden');

                btnAi.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeClass}`;
                btnManual.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${inactiveClass}`;
            } else {
                aiDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');

                btnAi.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${inactiveClass}`;
                btnManual.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeClass}`;
            }
        }

        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if (input.files.length > 0) {
                label.innerText = input.files[0].name;
                label.classList.add('text-green-600', 'font-bold');
            } else {
                label.innerText = "Nenhum arquivo";
                label.classList.remove('text-green-600', 'font-bold');
            }
        }

        function log(msg, type = 'info') {
            const out = document.getElementById('consoleOutput');
            const div = document.createElement('div');

            let colorClass = "text-gray-400";
            if (type === 'success') colorClass = "text-green-400 font-bold";
            if (type === 'error') colorClass = "text-red-400 font-bold";
            if (type === 'warn') colorClass = "text-yellow-400";

            div.className = `mb-1 ${colorClass}`;
            div.innerHTML = `<span class="opacity-30 mr-2">[${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}]</span> ${msg}`;
            out.prepend(div);
        }

        // --- AI LOGIC ---
        async function processCommand() {
            const text = document.getElementById('inputText').value;
            const key = document.getElementById('apiKey').value;
            const fileInput = document.getElementById('proofFileAi');

            if (!text) { log("Erro: Digite um comando.", 'error'); return; }

            log("Processando...", 'warn');

            let imageUrl = await handleUpload(fileInput, key, 'sys_ai');

            try {
                const response = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({ text: text, sender: 'Admin UI', image_url: imageUrl })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    log("Sucesso! Reserva criada/atualizada.", 'success');
                    log(data.message.replace(/\n/g, ' '), 'info');
                    document.getElementById('inputText').value = "";
                    fileInput.value = "";
                    updateFileName('proofFileAi', 'fileNameAi');
                } else {
                    log(`Erro API: ${data.message || 'Desconhecido'}`, 'error');
                }
            } catch (e) {
                log(`Erro Rede: ${e.message}`, 'error');
            }
        }

        // --- MANUAL LOGIC ---
        async function saveManual() {
            // Get Values
            const formIds = ['mChalet', 'mName', 'mCheckin', 'mCheckout'];
            const vals = {};
            let missing = false;

            formIds.forEach(id => {
                const el = document.getElementById(id);
                vals[id] = el.value;
                if (!el.value) { el.classList.add('border-red-500'); missing = true; }
                else { el.classList.remove('border-red-500'); }
            });

            if (missing) { alert("Preencha os campos obrigatórios (Chalé, Nome, Datas)."); return; }

            const key = document.getElementById('apiKey').value;
            const supabase = window.createClient(SUPABASE_URL, key);

            const btn = document.querySelector('#manualMode button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';
            btn.disabled = true;

            try {
                // Upload
                const fileInput = document.getElementById('mProof');
                const imageUrl = await handleUpload(fileInput, key, 'sys_manual');

                // Insert
                const insertData = {
                    chalet_id: document.getElementById('mChalet').value,
                    guest_name: document.getElementById('mName').value,
                    contact_info: document.getElementById('mContact').value,
                    checkin_date: document.getElementById('mCheckin').value,
                    checkout_date: document.getElementById('mCheckout').value,
                    adults: parseInt(document.getElementById('mAdults').value) || 2,
                    arrival_time: document.getElementById('mTime').value,
                    total_price: parseFloat(document.getElementById('mPrice').value) || 0,
                    advance_payment: parseFloat(document.getElementById('mPaid').value) || 0,
                    payment_proof_url: imageUrl,
                    status: 'pending',
                    raw_message: JSON.stringify({
                        manual: true,
                        ai_parsed: {
                            notes: document.getElementById('mNotes').value,
                            source: document.getElementById('mSource').value,
                            plate: document.getElementById('mPlate').value
                        }
                    })
                };

                const { error } = await supabase.from('bookings').insert(insertData);
                if (error) throw error;

                alert("Reserva Salva com Sucesso!");
                setMode('ai'); // Switch back or clear form
                log(`Reserva Manual criada para ${insertData.guest_name}`, 'success');

                // Clear Form (Optional, but good UX)
                document.getElementById('mName').value = "";
                document.getElementById('mNotes').value = "";
                document.getElementById('mPaid').value = "";
                document.getElementById('mProof').value = "";
                updateFileName('mProof', 'fileNameManual');

            } catch (err) {
                alert(`Erro ao salvar: ${err.message}`);
                console.error(err);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleUpload(fileInput, key, prefix) {
            if (fileInput.files.length === 0) return null;

            try {
                const supabase = window.createClient(SUPABASE_URL, key);
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `admin_uploads/${fileName}`;

                const { error } = await supabase.storage.from('receipts').upload(filePath, file);
                if (error) throw error;

                const { data } = supabase.storage.from('receipts').getPublicUrl(filePath);
                return data.publicUrl;
            } catch (err) {
                console.error("Upload Error", err);
                return null;
            }
        }
    </script>
</body>

</html>