<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin ‚Ä¢ Rio Preto</title>
    <link rel="icon" type="image/png" href="images/logo_opt.png">
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="theme.js"></script>

    <!-- Supabase JS -->
    <script src="https://esm.sh/@supabase/supabase-js@2"></script>

    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        h1,
        h2,
        h3,
        button {
            font-family: 'Outfit', sans-serif;
        }

        /* Smooth Fade */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-start md:justify-center p-4">

    <!-- AUTH MODAL -->
    <div id="authModal" class="fixed inset-0 z-[9999] bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                üîí
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Acesso Restrito</h2>
            <p class="text-gray-500 text-sm mb-6">Esta √°rea √© exclusiva para administra√ß√£o.</p>

            <input type="password" id="authInput" placeholder="Senha de Acesso"
                class="w-full text-center text-lg font-bold tracking-widest p-3 border border-gray-300 rounded-xl mb-4 focus:border-green-500 focus:outline-none uppercase">

            <button onclick="checkAuth()"
                class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition shadow-lg">
                ENTRAR
            </button>
            <p id="authError" class="text-red-500 text-xs font-bold mt-4 hidden">Senha Incorreta</p>
        </div>
    </div>

    <script>
        const AUTH_HASH = "8d83045952b2443d9f73353bcb3604f1a23cd00ebe46912129662d2f13cce8a9"; // SHA-256
        const STORAGE_KEY = "riopreto_admin_auth";

        async function checkAuth() {
            const input = document.getElementById('authInput');
            const err = document.getElementById('authError');
            const btn = document.querySelector('#authModal button');

            // Loading state
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(input.value.toUpperCase()); // Case insensitive check just in case, or stick to exact? User gave specific case. Let's stick to exact input but maybe trim.
                const dataExact = encoder.encode(input.value);

                const hashBuffer = await crypto.subtle.digest('SHA-256', dataExact);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                if (hashHex === AUTH_HASH) {
                    localStorage.setItem(STORAGE_KEY, 'true');
                    document.getElementById('authModal').remove();
                } else {
                    err.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    input.value = "";
                    if (btn) btn.innerHTML = "ENTRAR";
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao verificar senha.");
                if (btn) btn.innerHTML = "ENTRAR";
            }
        }

        // Auto-Check
        if (localStorage.getItem(STORAGE_KEY) === 'true') {
            document.getElementById('authModal').remove();
        }

        // Enter Key Support
        document.getElementById('authInput')?.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') checkAuth();
        });
    </script>

    <div
        class="w-full max-w-5xl bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[85vh] md:min-h-[600px] border border-gray-100">

        <!-- SIDEBAR (Desktop) / TOPBAR (Mobile) -->
        <div class="bg-gray-50 p-6 md:w-64 flex flex-col border-b md:border-b-0 md:border-r border-gray-100 shrink-0">
            <!-- Header Logo -->
            <div class="flex items-center justify-between mb-6 md:mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Painel<span class="text-green-600">Rio
                            Preto</span></h1>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Sistema de reservas
                        v2.3</p>
                </div>
                <!-- Back Button Mobile Only (Optional) -->
                <a href="index.html"
                    class="md:hidden w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-green-600">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
            </div>

            <!-- Security: Operator Name -->
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-green-600 uppercase tracking-wider mb-2">
                    <i class="fa-solid fa-user-shield mr-1"></i> Seu Nome (Obrigat√≥rio)
                </label>
                <input type="text" id="operatorName"
                    class="w-full bg-white border border-green-200 rounded-xl px-3 py-2 text-xs text-gray-800 font-bold focus:border-green-500 outline-none transition"
                    placeholder="Quem est√° operando?" onchange="saveOperatorName(this.value)">
            </div>

            <!-- Navigation Tabs -->
            <nav
                class="flex md:flex-col gap-2 md:gap-3 md:flex-1 overflow-x-auto md:overflow-visible pb-2 md:pb-0 no-scrollbar">
                <button onclick="setMode('ai')" id="btnAi"
                    class="flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all whitespace-nowrap bg-green-50 text-green-700 shadow-sm border border-green-100">
                    <i class="fa-solid fa-robot"></i> <span class="hidden sm:inline">IA Terminal</span><span
                        class="sm:hidden">IA</span>
                </button>
                <button onclick="setMode('manual')" id="btnManual"
                    class="flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all border border-transparent whitespace-nowrap">
                    <i class="fa-regular fa-pen-to-square"></i> <span class="hidden sm:inline">Manual</span><span
                        class="sm:hidden">Form</span>
                </button>
            </nav>

            <!-- Footer Desktop -->
            <div class="hidden md:block mt-auto pt-6 border-t border-gray-200">
                <a href="index.html"
                    class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-gray-600 transition">
                    <i class="fa-solid fa-arrow-left"></i> Voltar ao Site
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 relative bg-white overflow-hidden flex flex-col">

            <!-- AI MODE -->
            <div id="aiMode" class="flex flex-col h-full animate-fade-in overflow-y-auto custom-scrollbar p-4 md:p-8">

                <!-- AI Header -->
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Comando de Texto</h2>
                    <p class="text-xs text-gray-400 mt-1">Digite os detalhes da reserva naturalmente.</p>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 space-y-6">


                    <!-- Input & Action -->
                    <div class="space-y-4">
                        <textarea id="inputText" rows="5"
                            class="w-full bg-gray-50 border border-gray-200 rounded-2xl p-4 text-gray-800 font-medium focus:border-green-500 focus:bg-white focus:ring-4 focus:ring-green-50 outline-none transition text-base resize-none"
                            placeholder="Ex: Reserva Jo√£o Chal√© 5, entrada dia 25/12/2025, saida dia 26/12/2025, 2 adultos, 1 crian√ßa, pago R$ 250, contato: 69999999999, obs: churrasqueira inclusa 45 reais adicionais..."></textarea>

                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- File Upload Button -->
                            <label class="flex-1 cursor-pointer group">
                                <div
                                    class="flex items-center gap-3 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl group-hover:bg-gray-100 hover:border-green-300 transition">
                                    <div
                                        class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-paperclip"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <p class="text-xs font-bold text-gray-500 uppercase group-hover:text-gray-700">
                                            Comprovante</p>
                                        <p id="fileNameAi" class="text-[10px] text-gray-400 truncate">Nenhum arquivo</p>
                                    </div>
                                </div>
                                <input type="file" id="proofFileAi" class="hidden"
                                    onchange="updateFileName('proofFileAi', 'fileNameAi')">
                            </label>

                            <!-- Process Button -->
                            <button onclick="processCommand()"
                                class="flex-1 bg-green-500 text-white font-bold py-4 md:py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-paper-plane text-yellow-00 text-lg"></i>
                                <span class="uppercase tracking-wide text-sm">Enviar Pr√©-reserva</span>
                            </button>
                        </div>
                    </div>

                    <!-- Console Log -->
                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Log do Sistema</p>
                        <div id="consoleOutput"
                            class="bg-gray-900 rounded-xl p-4 h-48 overflow-y-auto custom-scrollbar font-mono text-xs text-gray-300 shadow-inner">
                            <div class="text-gray-600">O sistema est√° pronto...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- MANUAL MODE -->
            <div id="manualMode"
                class="hidden flex-col h-full animate-fade-in overflow-y-auto custom-scrollbar p-4 md:p-8">

                <div class="mb-6 flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-green-100 text-green-600 flex items-center justify-center text-lg">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Nova Reserva Manual</h2>
                </div>

                <div class="space-y-4 max-w-2xl">
                    <!-- Essential -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="col-span-1">
                            <label class="label-tiny">Chal√©</label>
                            <input type="number" id="mChalet" class="input-base" placeholder="#">
                        </div>
                        <div class="col-span-3">
                            <label class="label-tiny">Nome Completo</label>
                            <input type="text" id="mName" class="input-base" placeholder="Nome do H√≥spede">
                        </div>
                    </div>

                    <!-- Contact & Source -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Contato / Celular</label>
                            <input type="text" id="mContact" class="input-base" placeholder="(XX) 9XXXX-XXXX">
                        </div>
                        <div>
                            <label class="label-tiny">Origem</label>
                            <select id="mSource" class="input-base h-[46px]">
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Airbnb">Airbnb</option>
                                <option value="Booking">Booking.com</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Indica√ß√£o">Indica√ß√£o</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Check-in</label>
                            <input type="date" id="mCheckin" class="input-base">
                        </div>
                        <div>
                            <label class="label-tiny">Check-out</label>
                            <input type="date" id="mCheckout" class="input-base">
                        </div>
                    </div>

                    <!-- Pax & Time -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-tiny">Adultos/Crian√ßas</label>
                            <input type="text" id="mAdults" class="input-base" value="2 Adultos">
                        </div>
                        <div>
                            <label class="label-tiny">Chegada Prevista</label>
                            <input type="time" id="mTime" class="input-base" value="14:00">
                        </div>
                    </div>

                    <!-- Custom Styles for Inputs -->
                    <style>
                        .label-tiny {
                            font-size: 0.65rem;
                            font-weight: 800;
                            text-transform: uppercase;
                            color: #9ca3af;
                            margin-left: 4px;
                            margin-bottom: 2px;
                            display: block;
                        }

                        .input-base {
                            width: 100%;
                            padding: 12px;
                            border-radius: 12px;
                            background-color: #f9fafb;
                            border: 1px solid #e5e7eb;
                            font-weight: 600;
                            color: #1f2937;
                            outline: none;
                            transition: all 0.2s;
                            font-size: 0.9rem;
                        }

                        .input-base:focus {
                            background-color: #ffffff;
                            border-color: #22c55e;
                            box-shadow: 0 0 0 3px #dcfce7;
                        }
                    </style>

                    <!-- Money -->
                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div>
                            <label class="label-tiny">Total (R$)</label>
                            <input type="number" id="mPrice" class="input-base bg-white" placeholder="0.00">
                        </div>
                        <div>
                            <label class="label-tiny text-green-600">Pago (R$)</label>
                            <input type="number" id="mPaid"
                                class="input-base bg-green-50 text-green-700 border-green-200" placeholder="0.00">
                        </div>
                    </div>

                    <!-- Extra -->
                    <div>
                        <label class="label-tiny">Placa Ve√≠culo</label>
                        <input type="text" id="mPlate" class="input-base" placeholder="ABC-1234">
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="label-tiny">Observa√ß√µes</label>
                        <textarea id="mNotes" rows="2" class="input-base resize-none"
                            placeholder="Ber√ßo, Pet, Restri√ß√µes..."></textarea>
                    </div>

                    <!-- File -->
                    <label
                        class="flex items-center gap-4 p-4 border border-dashed border-gray-300 rounded-xl hover:bg-gray-50 cursor-pointer transition">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                            <i class="fa-solid fa-upload"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-600">Anexar Comprovante</p>
                            <p id="fileNameManual" class="text-xs text-gray-400">Nenhum arquivo</p>
                        </div>
                        <input type="file" id="mProof" class="hidden"
                            onchange="updateFileName('mProof', 'fileNameManual')">
                    </label>

                    <div class="h-4"></div> <!-- Spacer -->

                    <button onclick="saveManual()"
                        class="w-full py-4 rounded-xl bg-green-600 text-white font-bold text-lg shadow-lg shadow-green-200 hover:scale-[1.02] active:scale-95 transition-all">
                        CONFIRMAR RESERVA
                    </button>
                    <div class="h-8"></div> <!-- Bottom Spacer -->
                </div>

            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>

    <script>
        // --- CONSTANTS ---
        const CONFIG = {
            KEY_HARDCODED: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpaGFpcGFzbG5wYXFucW90cndtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjE1OTIsImV4cCI6MjA3OTgzNzU5Mn0.zwPHKlcYNQnlQbQdf83qbH3mk4Dsc8fVF4NfWDBs_LA",
            URL: "https://hihaipaslnpaqnqotrwm.supabase.co",
            FUNC: "https://hihaipaslnpaqnqotrwm.supabase.co/functions/v1/smooth-handler"
        };

        // Init
        // Operator Name Persistence
        const savedOperator = localStorage.getItem('riopreto_operator');
        if (savedOperator && document.getElementById('operatorName')) document.getElementById('operatorName').value = savedOperator;

        function saveOperatorName(val) {
            localStorage.setItem('riopreto_operator', val);
        }

        // --- TABS LOGIC ---
        function setMode(mode) {
            const ai = document.getElementById('aiMode');
            const manual = document.getElementById('manualMode');
            const btnAi = document.getElementById('btnAi');
            const btnManual = document.getElementById('btnManual');

            // Reset Styles
            const styleActive = "bg-green-50 text-green-700 shadow-sm border-green-100";
            const styleInactive = "text-gray-500 hover:bg-gray-100 border-transparent bg-transparent";

            // Clean
            btnAi.className = btnAi.className.replace(styleActive, "").replace(styleInactive, "");
            btnManual.className = btnManual.className.replace(styleActive, "").replace(styleInactive, "");

            // Base Class
            const base = "flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all whitespace-nowrap border ";

            if (mode === 'ai') {
                ai.classList.remove('hidden');
                manual.classList.add('hidden');
                manual.classList.remove('flex');

                btnAi.className = base + styleActive;
                btnManual.className = base + styleInactive;
            } else {
                ai.classList.add('hidden');
                manual.classList.remove('hidden');
                manual.classList.add('flex'); // Manual uses flex col

                btnAi.className = base + styleInactive;
                btnManual.className = base + styleActive;
            }
        }

        // --- UTILS ---
        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.classList.add('text-green-600', 'font-bold');
            } else {
                label.innerText = "Nenhum arquivo";
                label.classList.remove('text-green-600', 'font-bold');
            }
        }

        function log(msg, type = 'info') {
            const box = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = `mb-1.5 font-mono text-xs border-l-2 pl-2 ${type === 'error' ? 'text-red-400 border-red-500' :
                type === 'success' ? 'text-green-400 border-green-500 font-bold' :
                    'text-gray-400 border-gray-700'
                }`;
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}]</span> ${msg}`;
            box.prepend(div);
        }

        async function getSupabase() {
            return window.createClient(CONFIG.URL, CONFIG.KEY_HARDCODED);
        }

        async function getGeoLocation() {
            try {
                const resp = await fetch('https://ipapi.co/json/');
                const data = await resp.json();
                if (data.error) return "Unknown Location";
                return `${data.city}, ${data.region_code} (${data.latitude}, ${data.longitude})`;
            } catch (e) {
                return 'Unknown Location (Fetch Fail)';
            }
        }

        async function uploadFile(fileInput, prefix) {
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) return null;
            const file = fileInput.files[0];
            const sb = await getSupabase();

            const ext = file.name.split('.').pop();
            const path = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;

            try {
                const { error } = await sb.storage.from('receipts').upload(path, file);
                if (error) throw error;
                const { data } = sb.storage.from('receipts').getPublicUrl(path);
                return data.publicUrl;
            } catch (e) {
                console.error("Upload Fail", e);
                log("Falha upload imagem: " + e.message, 'error');
                return null;
            }
        }

        // --- ACTIONS ---
        async function processCommand() {
            const operator = document.getElementById('operatorName').value.trim();
            if (!operator) { alert("‚ö†Ô∏è Seguran√ßa: Digite SEU NOME no menu lateral antes de continuar."); return; }

            const text = document.getElementById('inputText').value;
            const fileIn = document.getElementById('proofFileAi');

            if (!text.trim()) { log("Digite um comando primeiro.", 'error'); return; }

            log("Enviando para IA...", 'warn');

            const url = await uploadFile(fileIn, 'ai_cmd');
            const key = CONFIG.KEY_HARDCODED;

            // Security Metadata
            const device = navigator.userAgent;
            const location = await getGeoLocation();

            try {
                const resp = await fetch(CONFIG.FUNC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        text,
                        madeby: operator,
                        device: device,
                        location: location,
                        image_url: url
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    log("‚úÖ Processado! " + (data.data?.length || 0) + " reserva(s) criada(s).", 'success');

                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(r => {
                            const isPending = r.status === 'pending';
                            const statusIcon = isPending ? '‚è≥' : '‚úÖ';
                            const statusText = isPending ? 'PENDENTE' : 'CONFIRMADO';
                            const assignedIcon = r.auto_assigned ? 'ü§ñ Auto-Atribu√≠do' : '';

                            const formatDateBr = (isoStr) => {
                                if (!isoStr) return "";
                                const [y, m, d] = isoStr.split('-');
                                return `${d}/${m}/${y}`;
                            };

                            const logHtml = `
                                <div class="mt-1 pl-2 border-l-2 border-gray-600 text-xs">
                                    <p><strong>Original:</strong> "${text}"</p>
                                    <p>${statusIcon} <strong>${r.guest_name}</strong> -> Chal√© ${r.chalet_id} <span class="text-[10px] bg-gray-700 px-1 rounded">${statusText}</span></p>
                                    <p>üìÖ ${formatDateBr(r.checkin_date)} a ${formatDateBr(r.checkout_date)}</p>
                                    <p>üë• ${r.adults} Adultos / Crian√ßas: Ver obs</p>
                                    <p>üí∞ Total: R$${r.total_price} (Pago: R$${r.advance_payment})</p>
                                    ${assignedIcon ? `<p class="text-blue-400">${assignedIcon}</p>` : ''}
                                </div>
                            `;
                            log(logHtml, 'success');
                        });
                    }

                    document.getElementById('inputText').value = "";
                    fileIn.value = "";
                    updateFileName('proofFileAi', 'fileNameAi');
                } else {
                    log("Erro IA: " + data.message, 'error');
                }

            } catch (e) {
                log("Erro Rede: " + e.message, 'error');
            }
        }

        async function saveManual() {
            const operator = document.getElementById('operatorName').value.trim();
            if (!operator) { alert("‚ö†Ô∏è Seguran√ßa: Digite SEU NOME no menu lateral antes de confirmar a reserva."); return; }

            // Validation
            const req = ['mChalet', 'mName', 'mCheckin', 'mCheckout'];
            let fail = false;
            req.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value) { el.style.borderColor = "red"; fail = true; }
                else { el.style.borderColor = ""; }
            });

            if (fail) { alert("Preencha campos obrigat√≥rios!"); return; }

            const btn = document.querySelector('#manualMode button');
            const originalText = btn.innerText;
            btn.innerText = "Verificando...";
            btn.disabled = true;

            try {
                const sb = await getSupabase();

                // 1. Check for Conflicts (Overlap)
                const chaletId = document.getElementById('mChalet').value;
                const checkin = document.getElementById('mCheckin').value;
                const checkout = document.getElementById('mCheckout').value;

                const { data: conflicts, error: conflictError } = await sb
                    .from('bookings')
                    .select('id, guest_name')
                    .eq('chalet_id', chaletId)
                    .lt('checkin_date', checkout)
                    .gt('checkout_date', checkin);

                if (conflictError) throw conflictError;

                if (conflicts && conflicts.length > 0) {
                    const confirmMsg = `‚ö†Ô∏è ATEN√á√ÉO: J√° existem ${conflicts.length} reserva(s) neste per√≠odo para o Chal√© ${chaletId}!\n\n` +
                        conflicts.map(c => `- ${c.guest_name}`).join('\n') +
                        `\n\nDeseja criar a reserva mesmo assim (Duplicidade)?`;

                    if (!confirm(confirmMsg)) {
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return; // Abort
                    }
                }

                btn.innerText = "Salvando...";

                const url = await uploadFile(document.getElementById('mProof'), 'manual_mob');
                const location = await getGeoLocation();

                const payload = {
                    chalet_id: document.getElementById('mChalet').value,
                    guest_name: document.getElementById('mName').value,
                    contact_info: document.getElementById('mContact').value,
                    checkin_date: document.getElementById('mCheckin').value,
                    checkout_date: document.getElementById('mCheckout').value,
                    adults: parseInt(document.getElementById('mAdults').value) || 2,
                    arrival_time: document.getElementById('mTime').value,
                    total_price: parseFloat(document.getElementById('mPrice').value) || 0,
                    advance_payment: parseFloat(document.getElementById('mPaid').value) || 0,
                    payment_proof_url: url,
                    status: 'pending',
                    // Security Columns
                    madeby: operator,
                    device: navigator.userAgent,
                    location: location,

                    raw_message: JSON.stringify({
                        manual: true,
                        madeby: operator,
                        device: navigator.userAgent,
                        location: location,
                        ai_parsed: {
                            notes: document.getElementById('mNotes').value,
                            source: document.getElementById('mSource').value,
                            plate: document.getElementById('mPlate').value
                        }
                    })
                };

                const { error } = await sb.from('bookings').insert(payload);
                if (error) throw error;

                alert("Pr√©-reserva Criada!");
                // Reset
                document.getElementById('mName').value = "";
                document.getElementById('mNotes').value = "";
                document.getElementById('mPaid').value = "";

                log(`Nova Reserva Manual: ${payload.guest_name}`, 'success');

            } catch (e) {
                alert("Erro: " + e.message);
            } finally {
                btn.innerText = document.querySelector('#manualMode button').innerText.includes("Salvando") ? "CONFIRMAR RESERVA" : originalText;
                if (btn.innerText === "Verificando...") btn.innerText = "CONFIRMAR RESERVA";
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>